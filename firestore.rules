/**
 * @fileoverview Firestore Security Rules for a Raffle System
 *
 * Core Philosophy:
 * This ruleset enforces a user-ownership model for purchases and raffle tickets.
 * Raffles are publicly readable but only modifiable by an admin (not yet implemented).
 *
 * Data Structure:
 * - /raffles/{raffleId}: Stores raffle event details. Publicly readable.
 * - /users/{userId}: Stores user profiles.
 * - /users/{userId}/purchases/{purchaseId}: Stores purchase history for each user.
 * - /raffleTickets/{raffleTicketId}: Stores individual raffle ticket data.
 *
 * Key Security Decisions:
 * - Raffles are publicly readable to allow for listing and discovery.
 * - Purchases are owned by the user who created them. Only the owner can read, update, or delete.
 * - Raffle tickets can be created and modified by an admin (not yet implemented).
 * - User listing is disabled.
 *
 * Denormalization for Authorization:
 * - Purchase documents include the userId, enabling direct ownership checks.
 *
 * Structural Segregation:
 * - Purchases are stored in a user-specific subcollection to ensure only the owner can access them.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows read access to raffle documents for everyone.
     * @path /raffles/{raffleId}
     * @allow (get, list) Any user can read raffle information.
     * @deny (create, update, delete) No user can modify raffle information without proper authorization.
     * @principle Grants public read access while restricting write access.
     */
    match /raffles/{raffleId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Restricts access to user documents to the owner only.
     * @path /users/{userId}
     * @allow (create) Allows a user to create their own document if the userId matches their auth UID.
     * @allow (get, list) Allows a user to read their own document if the userId matches their auth UID.
     * @allow (update, delete) Allows a user to update or delete their own document if the userId matches their auth UID.
     * @deny Any other user cannot access this document.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages user purchases. Only the owner can create, read, update or delete their own purchase history.
     * @path /users/{userId}/purchases/{purchaseId}
     * @allow (create) Allows a user to create a purchase under their ID, validating that the userId matches their auth UID.
     * @allow (get, list) Allows a user to retrieve their purchase if the userId matches their auth UID.
     * @allow (update, delete) Allows a user to update or delete their own purchase if the userId matches their auth UID.
     * @deny Any other user cannot access this purchase information.
     * @principle Enforces ownership for purchase records.
     */
    match /users/{userId}/purchases/{purchaseId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isOwner(userId) && resource != null && resource.data.userId == userId;
      allow delete: if isExistingOwner(userId) && resource.data.userId == userId;
    }

    /**
     * @description Manages individual raffle tickets.  No access control at this point.
     * @path /raffleTickets/{raffleTicketId}
     * @allow (get, list) Any user can read raffle ticket information.
     * @allow (create, update, delete) No user can modify raffle ticket information without proper authorization.
     */
    match /raffleTickets/{raffleTicketId} {
       allow get: if true;
       allow list: if true;
       allow create: if false;
       allow update: if false;
       allow delete: if false;
    }

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }
  }
}